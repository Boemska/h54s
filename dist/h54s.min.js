/*! h54s v0.7.0 - 2015-11-13 
 *  License: GPL V3 
 *  Author: Boemska 
*/

Object.create||(Object.create=function(a,b){function c(){}if("undefined"!=typeof b)throw"The multiple-argument version of Object.create is not provided by this browser and cannot be shimmed.";return c.prototype=a,new c}),Object.keys||(Object.keys=function(){"use strict";var a=Object.prototype.hasOwnProperty,b=!{toString:null}.propertyIsEnumerable("toString"),c=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],d=c.length;return function(e){if("object"!=typeof e&&("function"!=typeof e||null===e))throw new TypeError("Object.keys called on non-object");var f,g,h=[];for(f in e)a.call(e,f)&&h.push(f);if(b)for(g=0;d>g;g++)a.call(e,c[g])&&h.push(c[g]);return h}}()),Array.prototype.lastIndexOf||(Array.prototype.lastIndexOf=function(a){"use strict";if(void 0===this||null===this)throw new TypeError;var b,c,d=Object(this),e=d.length>>>0;if(0===e)return-1;for(b=e-1,arguments.length>1&&(b=Number(arguments[1]),b!=b?b=0:0!==b&&b!=1/0&&b!=-(1/0)&&(b=(b>0||-1)*Math.floor(Math.abs(b)))),c=b>=0?Math.min(b,e-1):e-Math.abs(b);c>=0;c--)if(c in d&&d[c]===a)return c;return-1});var h54s=function(a){function b(a){if(a){if("object"!=typeof a)throw new h54s.Error("argumentError","First parameter should be config object");for(var b in a)a.hasOwnProperty(b)&&("url"!==b&&"loginUrl"!==b||"/"===a[b].charAt(0)||(a[b]="/"+a[b]),this[b]=a[b]);a.hostUrl&&("/"===a.hostUrl.charAt(a.hostUrl.length-1)&&(a.hostUrl=a.hostUrl.slice(0,-1)),this.hostUrl=a.hostUrl,this.url=a.hostUrl+this.url,this.loginUrl=a.hostUrl+this.loginUrl),this._utils.ajax.setTimeout(this.ajaxTimeout)}}if(this.maxXhrRetries=5,this.url="/SASStoredProcess/do",this.debug=!1,this.loginUrl="/SASLogon/Logon.do",this.retryAfterLogin=!0,this.sasApp="Stored Process Web App 9.3",this.ajaxTimeout=3e4,this.remoteConfigUpdateCallbacks=[],this._pendingCalls=[],a&&a.isRemoteConfig){var c=this;this._disableCalls=!0,this._utils.ajax.get("/base/test/h54sConfig.json").success(function(d){var e=JSON.parse(d.responseText);for(var f in e)e.hasOwnProperty(f)&&void 0===a[f]&&"isRemoteConfig"!==f&&(a[f]=e[f]);b.call(c,a);for(var g=0,h=c.remoteConfigUpdateCallbacks.length;h>g;g++){var i=c.remoteConfigUpdateCallbacks[g];i()}for(c._disableCalls=!1;c._pendingCalls.length>0;){var j=c._pendingCalls.shift(),k=j.sasProgram,l=j.callback,m=j.params;m._debug=c.debug?131:0,c.call(k,null,l,m)}}).error(function(a){throw new h54s.Error("ajaxError","Remote config file cannot be loaded. Http status code: "+a.status)})}else b.call(this,a)};h54s.prototype.onRemoteConfigUpdate=function(a){this.remoteConfigUpdateCallbacks.push(a)},h54s.Error=function(a,b){Error.captureStackTrace&&Error.captureStackTrace(this),this.message=b,this.type=a},h54s.Error.prototype=Object.create(Error.prototype),h54s.Tables=function(a,b){this._tables={},this.add(a,b)},h54s.prototype.call=function(a,b,c,d){var e=this,f=0,g=this.debug;if(!c||"function"!=typeof c)throw new h54s.Error("argumentError","You must provide callback");if(!a)throw new h54s.Error("argumentError","You must provide Sas program file path");if("string"!=typeof a)throw new h54s.Error("argumentError","First parameter should be string");if(d||(d={_program:this.metadataRoot?this.metadataRoot.replace(/\/?$/,"/")+a.replace(/^\//,""):a,_debug:this.debug?131:0,_service:"default"}),b){if(!(b instanceof h54s.Tables))throw new h54s.Error("argumentError","Wrong type of tables object");for(var h in b._tables)b._tables.hasOwnProperty(h)&&(d[h]=b._tables[h])}return this._disableCalls?void this._pendingCalls.push({sasProgram:a,callback:c,params:d}):void this._utils.ajax.post(this.url,d).success(function(b){if(e._needToLogin(b)){if(e._pendingCalls.push({sasProgram:a,callback:c,params:d}),e._disableCalls)return;e._disableCalls=!0;try{var h=b.responseURL.match(/_sasapp=([^&]*)/);e.sasApp=h[1].replace(/\+/g," ")}catch(i){e._utils.addApplicationLogs("Cannot extract _sasapp parameter from login URL")}c(new h54s.Error("notLoggedinError","You are not logged in"))}else{var j,k;if(g)try{j=e._utils.parseDebugRes(b.responseText,a,d),j=e._utils.convertDates(j),k=e._utils.unescapeValues(j)}catch(i){e._utils.parseErrorResponse(b.responseText,a),c(new h54s.Error("parseError",i.message))}finally{k&&(e._utils.addApplicationLogs(j.logmessage),j.hasErrors?c(new h54s.Error("sasError","Sas program completed with errors"),k):c(void 0,k))}else try{j=JSON.parse(b.responseText.replace(/(\r\n|\r|\n)/g,"")),j=e._utils.convertDates(j),k=e._utils.unescapeValues(j)}catch(i){f<e.maxXhrRetries?(e._utils.ajax.post(e.url,d).success(this.success).error(this.error),f++,e._utils.addApplicationLogs("Retrying #"+f,a)):(e._utils.parseErrorResponse(b.responseText,a),e._utils.addFailedResponse(b.responseText,a),c(new h54s.Error("parseError","Unable to parse response json")))}finally{k&&(e._utils.addApplicationLogs(j.logmessage,a),c(void 0,k))}}}).error(function(b){e._utils.addApplicationLogs("Request failed with status: "+b.status,a),c(new h54s.Error("httpError",b.statusText))})},h54s.prototype.login=function(a,b,c){var d=this;if(!a||!b)throw new h54s.Error("argumentError","Credentials not set");if("string"!=typeof a||"string"!=typeof b)throw new h54s.Error("argumentError","User and pass parameters must be strings");if(!c||"function"!=typeof c)throw new h54s.Error("argumentError","You must provide callback");var e={_sasapp:d.sasApp,_service:"default",ux:a,px:b,username:a,password:b};for(var f in this._aditionalLoginParams)e[f]=this._aditionalLoginParams[f];this._utils.ajax.post(this.loginUrl,e).success(function(a){if(d._needToLogin(a))if(d._loginChanged||d._isNewLoginPage&&!d._aditionalLoginParams){delete d._loginChanged;var b=a.responseText.match(/<input.*"hidden"[^>]*>/g);b&&b.forEach(function(a){var b=a.match(/name="([^"]*)"\svalue="([^"]*)/);e[b[1]]=b[2]}),d._utils.ajax.post(d.loginUrl,e).success(this.success).error(this.error)}else d._utils.addApplicationLogs("Wrong username or password"),c(-1);else for(c(a.status),d._disableCalls=!1;d._pendingCalls.length>0;){var f=d._pendingCalls.shift(),g=f.sasProgram,h=f.callback,i=f.params;i._debug=d.debug?131:0,d.retryAfterLogin&&d.call(g,null,h,i)}}).error(function(a){d._utils.addApplicationLogs("Login failed with status code: "+a.status),c(a.status)})},h54s.prototype.getSasErrors=function(){return h54s._logs.sasErrors},h54s.prototype.getApplicationLogs=function(){return h54s._logs.applicationLogs},h54s.prototype.getDebugData=function(){return h54s._logs.debugData},h54s.prototype.getFailedRequests=function(){return h54s._logs.failedRequests},h54s.prototype.setDebugMode=function(){this.debug=!0},h54s.prototype.unsetDebugMode=function(){this.debug=!1},h54s.prototype.clearApplicationLogs=function(){h54s._logs.applicationLogs=[]},h54s.prototype.clearDebugData=function(){h54s._logs.debugData=[]},h54s.prototype.clearSasErrors=function(){h54s._logs.sasErrors=[]},h54s.prototype.clearFailedRequests=function(){h54s._logs.failedRequests=[]},h54s.prototype.clearAllLogs=function(){this.clearApplicationLogs(),this.clearDebugData(),this.clearSasErrors(),this.clearFailedRequests()},h54s.Tables.prototype.add=function(a,b){if(!a||!b)throw new h54s.Error("argumentError","Missing arguments");if(!(a instanceof Array))throw new h54s.Error("argumentError","First argument must be array");if("string"!=typeof b)throw new h54s.Error("argumentError","Second argument must be string");if(!isNaN(b[b.length-1]))throw new h54s.Error("argumentError","Macro name cannot have number at the end");var c=this._utils.convertTableObject(a),d=[];d.push(JSON.stringify(c.spec));for(var e=0;e<c.data.length;e++){var f=JSON.stringify(c.data[e]);d.push(f)}this._tables[b]=d},h54s.prototype._utils={},h54s.Tables.prototype._utils={},h54s._logs={applicationLogs:[],debugData:[],sasErrors:[],failedRequests:[]},h54s.prototype._utils.ajax=function(){var a,b=3e4,c=function(c,d,e){var f={success:function(){},error:function(){}},g=XMLHttpRequest||ActiveXObject,h=new g("MSXML2.XMLHTTP.3.0");return h.open(c,d,!0),h.setRequestHeader("Content-type","application/x-www-form-urlencoded"),h.onreadystatechange=function(){4===h.readyState&&(clearTimeout(a),h.status>=200&&h.status<300?f.success.call(f,h):f.error.call(f,h))},a=setTimeout(function(){h.abort()},b),h.send(e),{success:function(a){return f.success=a,this},error:function(a){return f.error=a,this}}},d=function(a){var b=[];for(var c in a)if(a.hasOwnProperty(c))if(a[c]instanceof Array)for(var d=0,e=a[c].length;e>d;d++)b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c][d]));else b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return b.join("&")};return{get:function(a,b){var e;"object"==typeof b&&(e=d(b));var f=e?a+"?"+e:a;return c("GET",f)},post:function(a,b){var e;return"object"==typeof b&&(e=d(b)),c("POST",a,e)},setTimeout:function(a){b=a}}}(),h54s.Tables.prototype._utils.convertTableObject=function(a){function b(a){return"undefined"==typeof f[a.colName]?(f[a.colName]={},f[a.colName].colName=a.colName,f[a.colName].colType=a.colType,f[a.colName].colLength=a.colLength>0?a.colLength:1,0):f[a.colName].colType!==a.colType?-1:f[a.colName].colLength<a.colLength?(f[a.colName].colLength=a.colLength>0?a.colLength:1,0):void 0}var c=this,d=3e4;if("object"!=typeof a)throw new h54s.Error("argumentError","The parameter passed to checkAndGetTypeObject is not an object");var e=a.length;if("number"!=typeof e)throw new h54s.Error("argumentError","The parameter passed to checkAndGetTypeObject does not have a valid length and is most likely not an array");var f={},g=0,h=[],i=0;h[i]=[];for(var j=0,k=0;k<a.length;k++){h[i][j]={};var l=0;for(var m in a[k]){var n={},o=a[k][m],p=typeof o,q=o instanceof Date;if("number"===p?((o<Number.MIN_SAFE_INTEGER||o>Number.MAX_SAFE_INTEGER)&&h54s.prototype._utils.addApplicationLogs.call(null,"Object["+k+"]."+m+" - This value exceeds expected numeric precision."),n.colName=m,n.colType="num",n.colLength=8,n.encodedLength=o.toString().length,h[i][j][m]=o):"string"!==p||q?q?(n.colName=m,n.colType="date",n.colLength=8,h[i][j][m]=c.toSasDateTime(o),n.encodedLength=h[i][j][m].toString().length):"object"==p&&(n.colName=m,n.colType="json",n.colLength=JSON.stringify(o).length,h[i][j][m]=encodeURIComponent(JSON.stringify(o)).replace(/'/g,"%27"),n.encodedLength=h[i][j][m].length):(n.colName=m,n.colType="string",n.colLength=o.length,""===o?h[i][j][m]=" ":h[i][j][m]=encodeURIComponent(o).replace(/'/g,"%27"),n.encodedLength=h[i][j][m].length),l=l+6+m.length+n.encodedLength,-1==b(n))throw new h54s.Error("typeError","There is a type mismatch in the array between elements (columns) of the same name.")}if(l>d)throw new h54s.Error("argumentError","Row "+j+" exceeds size limit of 32kb");if(g+l>d){var r=h[i].pop();i++,h[i]=[r],j=0,g=l}else g+=l;j++}var s=[];for(var t in f)s.push(f[t]);return{spec:s,data:h,jsonLength:g}},h54s.prototype._utils.parseDebugRes=function(a,b,c){var d=/^(.?--h54s-data-start--)([\S\s]*)(--h54s-data-end--)/m,e=a.match(d),f=a.replace(d,""),g=/<body.*>([\s\S]*)<\/body>/,h=f.match(g),i=h[1].replace(/<[^>]*>/g,"");i=this.decodeHTMLEntities(i),h54s._logs.debugData.push({debugHtml:h[1],debugText:i,sasProgram:b,params:c,time:new Date}),h54s._logs.debugData.length>20&&h54s._logs.debugData.shift(),this.parseErrorResponse(a,b);var j=JSON.parse(e[2].replace(/(\r\n|\r|\n)/g,""));return-1!==i.indexOf("ERROR:")&&(j.hasErrors=!0),j},h54s.prototype._utils.addFailedResponse=function(a,b){var c=/<script([\s\S]*)\/form>/,d=/display\s?:\s?none;?\s?/;a=a.replace(c,"").replace(d,"");var e=a.replace(/<[^>]*>/g,"");e=this.decodeHTMLEntities(e),h54s._logs.failedRequests.push({responseHtml:a,responseText:e,sasProgram:b,time:new Date}),h54s._logs.failedRequests.length>20&&h54s._logs.failedRequests.shift()},h54s.prototype._utils.unescapeValues=function(a){for(var b in a)"string"==typeof a[b]?a[b]=decodeURIComponent(a[b]):"object"==typeof a&&this.unescapeValues(a[b]);return a},h54s.prototype._utils.parseErrorResponse=function(a,b){var c=/ERROR(.*\.|.*\n.*\.)/g,d=a.match(c);if(d){for(var e,f=0,g=d.length;g>f;f++)e=d[f].replace(/<[^>]*>/g,"").replace(/(\n|\s{2,})/g," "),e=this.decodeHTMLEntities(e),d[f]={sasProgram:b,message:e,time:new Date};for(h54s._logs.sasErrors=h54s._logs.sasErrors.concat(d);h54s._logs.sasErrors.length>100;)h54s._logs.sasErrors.shift()}},h54s.prototype._utils.decodeHTMLEntities=function(a){var b=document.createElement("span"),c=a.replace(/&(#(?:x[0-9a-f]+|\d+)|[a-z]+);/gi,function(a){return b.innerHTML=a,a=b.textContent||b.innerText});return c},h54s.prototype._utils.addApplicationLogs=function(a,b){if("blank"!==a){var c={message:a,time:new Date,sasProgram:b};h54s._logs.applicationLogs.push(c),h54s._logs.applicationLogs.length>100&&h54s._logs.applicationLogs.shift()}},h54s.Tables.prototype._utils.toSasDateTime=function(a){var b=new Date("January 1, 1960 00:00:00"),c=a,d=b.getTimezoneOffset(),e=c.getTimezoneOffset(),f=60*(e-d),g=b.getTime()/1e3,h=c.getTime()/1e3,i=Math.round(h-g-f);return i},h54s.prototype._utils.fromSasDateTime=function(a){var b=new Date("January 1, 1960 00:00:00"),c=a,d=b.getTimezoneOffset(),e=b.getTime(),f=1e3*c,g=f+e,h=new Date;h.setTime(g);var i=h.getTimezoneOffset(),j=60*(d-i)*1e3,k=g-j;return h.setTime(k),h},h54s.prototype._utils.convertDates=function(a){for(var b in a)"number"!=typeof a[b]||0!==b.indexOf("dt_")&&0!==b.indexOf("DT_")?"object"==typeof a&&this.convertDates(a[b]):a[b]=this.fromSasDateTime(a[b]);return a},h54s.prototype._needToLogin=function(a){var b,c=/<form.+action="(.*Logon[^"]*).*>/,d=c.exec(a.responseText);if(d){var e=d[1].replace(/\?.*/,"");if("/"===e.charAt(0))b=this.hostUrl?this.hostUrl+e:e,b!==this.loginUrl&&(this._loginChanged=!0,this.loginUrl=b);else{var f=a.responseURL.lastIndexOf("/")+1,g=a.responseURL.substr(0,f).replace(/.*\/{2}[^\/]*/,"")+e;b=this.hostUrl?this.hostUrl+g:g,b!==this.loginUrl&&(this._loginChanged=!0,this.loginUrl=b)}var h=a.responseText.match(/<input.*"hidden"[^>]*>/g),i={};return h&&(this._isNewLoginPage=!0,h.forEach(function(a){var b=a.match(/name="([^"]*)"\svalue="([^"]*)/);i[b[1]]=b[2]}),this._aditionalLoginParams=i),!0}return!1};
//# sourceMappingURL=h54s.min.js.map