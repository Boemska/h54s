/*! h54s v0.6.3 - 2015-10-09 
 *  License: GPL 
 *  Author: Boemska 
*/

function _setConfig(a){if(a){if("object"!=typeof a)throw new h54s.Error("argumentError","First parameter should be config object");for(var b in a)a.hasOwnProperty(b)&&("url"!==b&&"loginUrl"!==b||"/"===a[b].charAt(0)||(a[b]="/"+a[b]),this[b]=a[b]);a.hostUrl&&("/"===a.hostUrl.charAt(a.hostUrl.length-1)&&(a.hostUrl=a.hostUrl.slice(0,-1)),this.hostUrl=a.hostUrl,this.url=a.hostUrl+this.url,this.loginUrl=a.hostUrl+this.loginUrl),this._utils.ajax.setTimeout(this.ajaxTimeout)}}Object.create||(Object.create=function(a,b){function c(){}if("undefined"!=typeof b)throw"The multiple-argument version of Object.create is not provided by this browser and cannot be shimmed.";return c.prototype=a,new c}),Object.keys||(Object.keys=function(){"use strict";var a=Object.prototype.hasOwnProperty,b=!{toString:null}.propertyIsEnumerable("toString"),c=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],d=c.length;return function(e){if("object"!=typeof e&&("function"!=typeof e||null===e))throw new TypeError("Object.keys called on non-object");var f,g,h=[];for(f in e)a.call(e,f)&&h.push(f);if(b)for(g=0;d>g;g++)a.call(e,c[g])&&h.push(c[g]);return h}}());var h54s=function(a){if(this.maxXhrRetries=5,this.url="/SASStoredProcess/do",this.debug=!1,this.loginUrl="/SASLogon/Logon.do",this.retryAfterLogin=!0,this.sasApp="Stored Process Web App 9.3",this.ajaxTimeout=3e4,this.remoteConfigUpdateCallbacks=[],this._pendingCalls=[],a&&a.isRemoteConfig){var b=this;this._disableCalls=!0,this._utils.ajax.get("/base/test/h54sConfig.json").success(function(c){var d=JSON.parse(c.responseText);for(var e in d)d.hasOwnProperty(e)&&void 0===a[e]&&"isRemoteConfig"!==e&&(a[e]=d[e]);_setConfig.call(b,a);for(var f=0,g=b.remoteConfigUpdateCallbacks.length;g>f;f++){var h=b.remoteConfigUpdateCallbacks[f];h()}for(b._disableCalls=!1;b._pendingCalls.length>0;){var i=b._pendingCalls.shift(),j=i.sasProgram,k=i.callback,l=i.params;l._debug=b.debug?131:0,b.call(j,null,k,l)}}).error(function(a){throw new h54s.Error("ajaxError","Remote config file cannot be loaded. Http status code: "+a.status)})}else _setConfig.call(this,a)};h54s.prototype.onRemoteConfigUpdate=function(a){this.remoteConfigUpdateCallbacks.push(a)},h54s.Error=function(a,b){Error.captureStackTrace&&Error.captureStackTrace(this),this.message=b,this.type=a},h54s.Error.prototype=Object.create(Error.prototype),h54s.Tables=function(a,b){this._tables={},this.add(a,b)},h54s.prototype.call=function(a,b,c,d){var e=this,f=0,g=this.debug;if(!c||"function"!=typeof c)throw new h54s.Error("argumentError","You must provide callback");if(!a)throw new h54s.Error("argumentError","You must provide Sas program file path");if("string"!=typeof a)throw new h54s.Error("argumentError","First parameter should be string");if(d||(d={_program:this.metadataRoot?this.metadataRoot.replace(/\/?$/,"/")+a.replace(/^\//,""):a,_debug:this.debug?131:0,_service:"default"}),b){if(!(b instanceof h54s.Tables))throw new h54s.Error("argumentError","Wrong type of tables object");for(var h in b._tables)b._tables.hasOwnProperty(h)&&(d[h]=b._tables[h])}return this._disableCalls?void this._pendingCalls.push({sasProgram:a,callback:c,params:d}):void this._utils.ajax.post(this.url,d).success(function(b){if(e._disableCalls)return void e._pendingCalls.push({sasProgram:a,callback:c,params:d});if(/<form.+action="Logon.do".+/.test(b.responseText)){e._disableCalls=!0,e._pendingCalls.push({sasProgram:a,callback:c,params:d});try{var h=b.responseURL.match(/_sasapp=([^&]*)/);e.sasApp=h[1].replace(/\+/g," ")}catch(i){e._utils.addApplicationLogs("Cannot extract _sasapp parameter from login URL")}c(new h54s.Error("notLoggedinError","You are not logged in"))}else{var j,k;if(g)try{j=e._utils.parseDebugRes(b.responseText,a,d),j=e._utils.convertDates(j),k=e._utils.unescapeValues(j)}catch(i){e._utils.parseErrorResponse(b.responseText,a),c(new h54s.Error("parseError","Unable to parse response json"))}finally{k&&(e._utils.addApplicationLogs(j.logmessage),j.hasErrors?c(new h54s.Error("sasError","Sas program completed with errors"),k):c(void 0,k))}else try{j=JSON.parse(b.responseText.replace(/(\r\n|\r|\n)/g,"")),j=e._utils.convertDates(j),k=e._utils.unescapeValues(j)}catch(i){f<e.maxXhrRetries?(e._utils.ajax.post(e.url,d).success(this.success).error(this.error),f++,e._utils.addApplicationLogs("Retrying #"+f,a)):(e._utils.parseErrorResponse(b.responseText,a),e._utils.addFailedResponse(b.responseText,a),c(new h54s.Error("parseError","Unable to parse response json")))}finally{k&&(e._utils.addApplicationLogs(j.logmessage,a),c(void 0,k))}}}).error(function(b){e._utils.addApplicationLogs("Request failed with status: "+b.status,a),c(new h54s.Error("httpError",b.statusText))})},h54s.prototype.login=function(a,b,c){var d=this;if(!a||!b)throw new h54s.Error("argumentError","Credentials not set");if("string"!=typeof a||"string"!=typeof b)throw new h54s.Error("argumentError","User and pass parameters must be strings");if(!c||"function"!=typeof c)throw new h54s.Error("argumentError","You must provide callback");var e=function(a){"function"==typeof c&&c(a)};this._utils.ajax.post(this.loginUrl,{_sasapp:d.sasApp,_service:"default",ux:a,px:b}).success(function(a){if(/<form.+action="Logon.do".+/.test(a.responseText))d._utils.addApplicationLogs("Wrong username or password"),e(-1);else for(e(a.status),d._disableCalls=!1;d._pendingCalls.length>0;){var b=d._pendingCalls.shift(),c=b.sasProgram,f=b.callback,g=b.params;g._debug=d.debug?131:0,d.retryAfterLogin&&d.call(c,null,f,g)}}).error(function(a){d._utils.addApplicationLogs("Login failed with status code: "+a.status),e(a.status)})},h54s.prototype.getSasErrors=function(){return this._utils._sasErrors},h54s.prototype.getApplicationLogs=function(){return this._utils._applicationLogs},h54s.prototype.getDebugData=function(){return this._utils._debugData},h54s.prototype.getFailedRequests=function(){return this._utils._failedRequests},h54s.prototype.setDebugMode=function(){this.debug=!0},h54s.prototype.unsetDebugMode=function(){this.debug=!1},h54s.prototype.clearApplicationLogs=function(){this._utils._applicationLogs=[]},h54s.prototype.clearDebugData=function(){this._utils._debugData=[]},h54s.prototype.clearSasErrors=function(){this._utils._sasErrors=[]},h54s.prototype.clearFailedRequests=function(){this._utils._failedRequests=[]},h54s.prototype.clearAllLogs=function(){this.clearApplicationLogs(),this.clearDebugData(),this.clearSasErrors(),this.clearFailedRequests()},h54s.Tables.prototype.add=function(a,b){if(!a||!b)throw new h54s.Error("argumentError","Missing arguments");if(!(a instanceof Array))throw new h54s.Error("argumentError","First argument must be array");if("string"!=typeof b)throw new h54s.Error("argumentError","Second argument must be string");if(!isNaN(b[b.length-1]))throw new h54s.Error("argumentError","Macro name cannot have number at the end");var c=this._utils.convertTableObject(a),d=[];d.push(JSON.stringify(c.spec));for(var e=0;e<c.data.length;e++){var f=JSON.stringify(c.data[e]);d.push(f)}this._tables[b]=d},h54s.prototype._utils={},h54s.Tables.prototype._utils={},h54s.prototype._utils._applicationLogs=[],h54s.prototype._utils._debugData=[],h54s.prototype._utils._sasErrors=[],h54s.prototype._utils._failedRequests=[],h54s.prototype._utils.ajax=function(){var a,b=3e4,c=function(c,d,e){var f={success:function(){},error:function(){}},g=XMLHttpRequest||ActiveXObject,h=new g("MSXML2.XMLHTTP.3.0");return h.open(c,d,!0),h.setRequestHeader("Content-type","application/x-www-form-urlencoded"),h.onreadystatechange=function(){4===h.readyState&&(clearTimeout(a),h.status>=200&&h.status<300?f.success.call(f,h):f.error.call(f,h))},a=setTimeout(function(){h.abort()},b),h.send(e),{success:function(a){return f.success=a,this},error:function(a){return f.error=a,this}}},d=function(a){var b=[];for(var c in a)if(a.hasOwnProperty(c))if(a[c]instanceof Array)for(var d=0,e=a[c].length;e>d;d++)b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c][d]));else b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return b.join("&")};return{get:function(a,b){var e;"object"==typeof b&&(e=d(b));var f=e?a+"?"+e:a;return c("GET",f)},post:function(a,b){var e;return"object"==typeof b&&(e=d(b)),c("POST",a,e)},setTimeout:function(a){b=a}}}(),h54s.Tables.prototype._utils.convertTableObject=function(a){function b(a){return"undefined"==typeof f[a.colName]?(f[a.colName]={},f[a.colName].colName=a.colName,f[a.colName].colType=a.colType,f[a.colName].colLength=a.colLength>0?a.colLength:1,0):f[a.colName].colType!==a.colType?-1:f[a.colName].colLength<a.colLength?(f[a.colName].colLength=a.colLength>0?a.colLength:1,0):void 0}var c=this,d=3e4;if("object"!=typeof a)throw new h54s.Error("argumentError","The parameter passed to checkAndGetTypeObject is not an object");var e=a.length;if("number"!=typeof e)throw new h54s.Error("argumentError","The parameter passed to checkAndGetTypeObject does not have a valid length and is most likely not an array");var f={},g=0,h=[],i=0;h[i]=[];for(var j=0,k=0;k<a.length;k++){h[i][j]={};var l=0;for(var m in a[k]){var n={},o=a[k][m],p=typeof o,q=o instanceof Date;if("number"===p?(n.colName=m,n.colType="num",n.colLength=8,n.encodedLength=o.toString().length,h[i][j][m]=o):"string"!==p||q?q?(n.colName=m,n.colType="date",n.colLength=8,h[i][j][m]=c.toSasDateTime(o),n.encodedLength=h[i][j][m].toString().length):"object"==p&&(n.colName=m,n.colType="json",n.colLength=JSON.stringify(o).length,h[i][j][m]=encodeURIComponent(JSON.stringify(o)).replace(/'/g,"%27"),n.encodedLength=h[i][j][m].length):(n.colName=m,n.colType="string",n.colLength=o.length,""===o?h[i][j][m]=" ":h[i][j][m]=encodeURIComponent(o).replace(/'/g,"%27"),n.encodedLength=h[i][j][m].length),l=l+6+m.length+n.encodedLength,-1==b(n))throw new h54s.Error("typeError","There is a type mismatch in the array between elements (columns) of the same name.")}if(l>d)throw new h54s.Error("argumentError","Row "+j+" exceeds size limit of 32kb");if(g+l>d){var r=h[i].pop();i++,h[i]=[r],j=0,g=l}else g+=l;j++}var s=[];for(var t in f)s.push(f[t]);return{spec:s,data:h,jsonLength:g}},h54s.prototype._utils.parseDebugRes=function(a,b,c){var d=/^(.?--h54s-data-start--)([\S\s]*)(--h54s-data-end--)/m,e=a.match(d),f=a.replace(d,""),g=/<body.*>([\s\S]*)<\/body>/,h=f.match(g),i=h[1].replace(/<[^>]*>/g,"");i=this.decodeHTMLEntities(i),this._debugData.push({debugHtml:h[1],debugText:i,sasProgram:b,params:c,time:new Date}),this._debugData.length>20&&this._debugData.shift(),this.parseErrorResponse(a,b);var j=JSON.parse(e[2].replace(/(\r\n|\r|\n)/g,""));return-1!==i.indexOf("ERROR:")&&(j.hasErrors=!0),j},h54s.prototype._utils.addFailedResponse=function(a,b){var c=/<script([\s\S]*)\/form>/,d=/display\s?:\s?none;?\s?/;a=a.replace(c,"").replace(d,"");var e=a.replace(/<[^>]*>/g,"");e=this.decodeHTMLEntities(e),this._failedRequests.push({responseHtml:a,responseText:e,sasProgram:b,time:new Date}),this._failedRequests.length>20&&this._failedRequests.shift()},h54s.prototype._utils.unescapeValues=function(a){for(var b in a)"string"==typeof a[b]?a[b]=decodeURIComponent(a[b]):"object"==typeof a&&this.unescapeValues(a[b]);return a},h54s.prototype._utils.parseErrorResponse=function(a,b){var c=/ERROR(.*\.|.*\n.*\.)/g,d=a.match(c);if(d){for(var e,f=0,g=d.length;g>f;f++)e=d[f].replace(/<[^>]*>/g,"").replace(/(\n|\s{2,})/g," "),e=this.decodeHTMLEntities(e),d[f]={sasProgram:b,message:e,time:new Date};for(this._sasErrors=this._sasErrors.concat(d);this._sasErrors.length>100;)this._sasErrors.shift()}},h54s.prototype._utils.decodeHTMLEntities=function(a){var b=document.createElement("span"),c=a.replace(/&(#(?:x[0-9a-f]+|\d+)|[a-z]+);/gi,function(a){return b.innerHTML=a,a=b.textContent||b.innerText});return c},h54s.prototype._utils.addApplicationLogs=function(a,b){if("blank"!==a){var c={message:a,time:new Date,sasProgram:b};this._applicationLogs.push(c),this._applicationLogs.length>100&&this._applicationLogs.shift()}},h54s.Tables.prototype._utils.toSasDateTime=function(a){var b=new Date("January 1, 1960 00:00:00"),c=a,d=b.getTimezoneOffset(),e=c.getTimezoneOffset(),f=60*(e-d),g=b.getTime()/1e3,h=c.getTime()/1e3,i=Math.round(h-g-f);return i},h54s.prototype._utils.fromSasDateTime=function(a){var b=new Date("January 1, 1960 00:00:00"),c=a,d=b.getTimezoneOffset(),e=b.getTime(),f=1e3*c,g=f+e,h=new Date;h.setTime(g);var i=h.getTimezoneOffset(),j=60*(d-i)*1e3,k=g-j;return h.setTime(k),h},h54s.prototype._utils.convertDates=function(a){for(var b in a)"number"!=typeof a[b]||0!==b.indexOf("dt_")&&0!==b.indexOf("DT_")?"object"==typeof a&&this.convertDates(a[b]):a[b]=this.fromSasDateTime(a[b]);return a};
//# sourceMappingURL=h54s.min.js.map